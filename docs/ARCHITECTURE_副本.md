# Web3 EIP Playground - 整体架构文档

## 一、项目定位

**Web3 EIP Playground** 是一个通过游戏学习 ERC/EIP 标准的 Web3 教育平台。

核心理念：**Learn by Doing, Not Reading**

用户价值：

- 玩小游戏理解 ERC-20、ERC-721 等标准
- 阅读漫画式解释，降低学习门槛
- 向 AI 导师提问，获得通俗解答
- 通关后获得 NFT 成就徽章

---

## 二、项目结构

```
web3-eip-playground/
├── apps/
│   ├── frontend/          # 前端 (Next.js)
│   └── backend/           # 后端 (FastAPI) [待建]
├── contract/              # 智能合约 (Foundry)
├── spoon-core/            # AI Agent SDK
├── docs/                  # 项目文档
└── README.md
```

| 模块 | 技术栈 | 职责 |
|------|--------|------|
| `apps/frontend` | Next.js 16 + React 19 + TypeScript + ethers.js v6 + Tailwind CSS | 页面渲染、游戏交互、钱包连接、NFT 展示 |
| `apps/backend` | Python 3.12+ + FastAPI + web3.py + spoon-core | NFT 铸造服务、AI 导师服务、数据存储 |
| `contract` | Solidity 0.8.24 + Foundry + OpenZeppelin | ERC-721 NFT 合约 |
| `spoon-core` | Python + SpoonAI SDK | AI Agent 框架，用于 AI 导师功能 |

---

## 三、整体架构图

```
                              ┌──────────┐
                              │   用户   │
                              │  (浏览器) │
                              └─────┬────┘
                                    │
                    ┌───────────────┼───────────────┐
                    │               │               │
                    ▼               ▼               ▼
             ┌───────────┐  ┌───────────┐  ┌───────────┐
             │ MetaMask  │  │ 学习游戏  │  │  AI 问答  │
             │ 连接钱包  │  │ 闯关交互  │  │  概念解释  │
             └─────┬─────┘  └─────┬─────┘  └─────┬─────┘
                   │              │              │
                   └──────────────┼──────────────┘
                                  │
                                  ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        前端 (apps/frontend)                          │
│                        Next.js + React + ethers.js                   │
│                                                                      │
│  ┌───────────┐  ┌───────────┐  ┌───────────┐  ┌───────────┐         │
│  │   首页    │  │  EIP 学习 │  │  游戏页面 │  │  我的 NFT │         │
│  │  导航入口 │  │  漫画+游戏│  │  闯关逻辑 │  │  成就展示 │         │
│  └───────────┘  └───────────┘  └───────────┘  └───────────┘         │
│                                                                      │
│  ethers.js：连接钱包、获取地址、读取 tokenURI、查询用户 NFT           │
└───────────────────────────┬──────────────────────────────────────────┘
                            │
                            │ HTTP API
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        后端 (apps/backend)                           │
│                        Python FastAPI                                │
│                                                                      │
│  ┌──────────────────────────┐  ┌──────────────────────────┐         │
│  │     NFT 铸造模块         │  │     AI 导师模块          │         │
│  │                          │  │                          │         │
│  │  POST /api/game/clear    │  │  POST /api/chat          │         │
│  │  • 验证通关请求          │  │  • 接收用户问题          │         │
│  │  • 检查幂等(防重复发放)  │  │  • 调用 spoon-core       │         │
│  │  • 生成 claimId          │  │  • 返回 AI 回答          │         │
│  │  • 用 Minter 钱包调合约  │  │                          │         │
│  │                          │  │  GET /api/chat/history    │         │
│  │  GET /api/nft/list       │  │  • 获取对话历史          │         │
│  │  • 查询用户的 NFT 列表   │  │                          │         │
│  └──────────────────────────┘  └──────────────────────────┘         │
│                                                                      │
│  ┌──────────────────────────┐  ┌──────────────────────────┐         │
│  │   Minter 钱包管理        │  │     通用模块             │         │
│  │   • 私钥安全存储(env)    │  │  • 数据库                │         │
│  │   • web3.py 签名发交易   │  │  • 日志 & 监控           │         │
│  └──────────────────────────┘  └──────────────────────────┘         │
└───────────────────────────┬──────────────────────────────────────────┘
                            │
                            │ RPC (JSON-RPC)
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        区块链层 (contract)                            │
│                        以太坊 / L2 网络                               │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐  │
│  │                    GameBadgeNFT.sol                             │  │
│  │                    ERC-721 可转移 NFT                           │  │
│  │                                                                 │  │
│  │  状态变量:                                                      │  │
│  │  • nextTokenId      下一个 token ID                             │  │
│  │  • baseURI          IPFS 元数据前缀                             │  │
│  │  • minter           铸造权限地址                                │  │
│  │  • paused           暂停开关                                    │  │
│  │  • tokenToIndex     tokenId => 图案索引(0-14)                   │  │
│  │  • claimUsed        claimId => 是否已使用                       │  │
│  │                                                                 │  │
│  │  核心函数:                                                      │  │
│  │  • mintTo(to, gameId, claimId)  铸造 NFT                        │  │
│  │  • tokenURI(tokenId)           返回元数据 URI                   │  │
│  │                                                                 │  │
│  │  管理函数:                                                      │  │
│  │  • setBaseURI()  setMinter()  setPaused()                       │  │
│  │                                                                 │  │
│  │  事件:                                                          │  │
│  │  • Minted(to, tokenId, index, gameId, claimId)                  │  │
│  └────────────────────────────────────────────────────────────────┘  │
└───────────────────────────┬──────────────────────────────────────────┘
                            │
                            ▼
┌──────────────────────────────────────────────────────────────────────┐
│                        外部存储 (IPFS / Pinata)                      │
│                                                                      │
│  ipfs://<METADATA_FOLDER_CID>/                                       │
│  ├── 0.json   { name, description, image: "ipfs://xxx/0.png" }      │
│  ├── 1.json                                                          │
│  ├── ...                                                             │
│  └── 14.json                                                         │
│                                                                      │
│  ├── 0.png    NFT 图片                                               │
│  ├── 1.png                                                           │
│  ├── ...                                                             │
│  └── 14.png                                                          │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 四、核心业务流程

### 流程 1：用户学习 + 闯关 + 获得 NFT

```
  ┌─────────┐
  │  开始   │
  └────┬────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 1：连接钱包                                                 │
  │                                                                 │
  │   用户 → 前端 → MetaMask → 用户授权 → 前端获取 userAddress      │
  │                                                                 │
  │   技术：ethers.js BrowserProvider                               │
  │   存储：前端保存 userAddress                                     │
  └─────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 2：选择学习内容                                             │
  │                                                                 │
  │   用户选择学习模块：                                             │
  │   • ERC-20 (同质化代币)                                          │
  │   • ERC-721 (NFT)                                               │
  │   • EIP-4337 (账户抽象)                                          │
  │   • ...                                                         │
  │                                                                 │
  │   每个模块包含：漫画解释 + 小游戏                                 │
  └─────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 3：阅读漫画 + 玩游戏                                        │
  │                                                                 │
  │   前端展示：                                                     │
  │   • 漫画式图文解释概念                                           │
  │   • 互动小游戏（拖拽、选择、模拟操作等）                           │
  │                                                                 │
  │   游戏过程中可随时向 AI 导师提问                                  │
  └─────────────────────────────────────────────────────────────────┘
       │
       ▼
  ┌────────────┐
  │  通关成功?  │
  └─────┬──────┘
        │
   ┌────┴────┐
   否        是
   │         │
   ▼         ▼
┌──────┐   ┌─────────────────────────────────────────────────────────┐
│ 继续 │   │ 步骤 4：前端请求铸造                                     │
│ 闯关 │   │                                                         │
└──────┘   │   前端 → POST /api/game/clear                           │
           │   {                                                     │
           │     userAddress: "0xABC...",                             │
           │     gameId: 1,                                          │
           │     runId: "uuid-xxx"                                   │
           │   }                                                     │
           └─────────────────────────────────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 5：后端验证 + 生成 claimId                                  │
  │                                                                 │
  │   1. 验证请求合法性                                              │
  │      • userAddress 格式正确                                     │
  │      • gameId 存在                                              │
  │      • 可选：验证用户确实完成了游戏（防作弊）                     │
  │                                                                 │
  │   2. 检查幂等                                                    │
  │      • 查数据库：该 user + gameId + runId 是否已发放过           │
  │      • 如果已发放，直接返回之前的 tokenId                        │
  │                                                                 │
  │   3. 生成 claimId                                                │
  │      claimId = keccak256(chainId + contractAddr + user +        │
  │                          gameId + runId + timestamp)             │
  │      确保全局唯一                                                │
  └─────────────────────────────────────────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 6：后端调用合约铸造                                         │
  │                                                                 │
  │   后端 (web3.py)：                                               │
  │   1. 加载 Minter 私钥（从环境变量）                              │
  │   2. 构造交易                                                    │
  │      contract.functions.mintTo(userAddress, gameId, claimId)    │
  │   3. 签名 + 发送交易                                             │
  │   4. 等待交易确认                                                │
  │                                                                 │
  │   Gas 费由项目方 Minter 钱包支付，用户无感知                      │
  └─────────────────────────────────────────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 7：合约执行铸造                                             │
  │                                                                 │
  │   GameBadgeNFT.mintTo() 执行：                                  │
  │   1. 权限检查   → if (msg.sender != minter) revert             │
  │   2. 暂停检查   → if (paused) revert                           │
  │   3. 防重放检查 → if (claimUsed[claimId]) revert               │
  │   4. 生成 tokenId = nextTokenId++                               │
  │   5. 生成随机 index (0-14)                                      │
  │   6. 标记 claimUsed[claimId] = true                             │
  │   7. _safeMint(to, tokenId)                                     │
  │   8. emit Minted(to, tokenId, index, gameId, claimId)           │
  └─────────────────────────────────────────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 8：后端解析事件 + 存储                                      │
  │                                                                 │
  │   从交易回执中解析 Minted 事件：                                 │
  │   { to, tokenId, index, gameId, claimId }                       │
  │                                                                 │
  │   存入数据库：                                                   │
  │   INSERT INTO nft_records (user, token_id, index, game_id, ...) │
  └─────────────────────────────────────────────────────────────────┘
               │
               ▼
  ┌─────────────────────────────────────────────────────────────────┐
  │ 步骤 9：返回前端 + 展示 NFT                                     │
  │                                                                 │
  │   后端返回：                                                     │
  │   { success: true, tokenId: 1, index: 7, txHash: "0x..." }     │
  │                                                                 │
  │   前端展示：                                                     │
  │   1. 调用合约 tokenURI(tokenId)                                 │
  │      → "ipfs://<CID>/7.json"                                    │
  │   2. 从 IPFS 获取元数据                                          │
  │      { name, description, image: "ipfs://xxx/7.png" }          │
  │   3. 展示 NFT 图片 + 信息                                       │
  │      "恭喜获得 ERC-721 学习徽章！"                               │
  └─────────────────────────────────────────────────────────────────┘
               │
               ▼
          ┌─────────┐
          │  完成   │
          └─────────┘
```

### 流程 2：AI 导师问答

```
  用户                    前端                      后端                 spoon-core
   │                       │                        │                        │
   │  "ERC-20 是什么？"     │                        │                        │
   │ ─────────────────────►│                        │                        │
   │                       │  POST /api/chat        │                        │
   │                       │  { message, userId }   │                        │
   │                       │ ──────────────────────►│                        │
   │                       │                        │  调用 AI Agent         │
   │                       │                        │ ──────────────────────►│
   │                       │                        │                        │ LLM 处理
   │                       │                        │  ◄─── AI 回答 ─────────│
   │                       │  ◄─── 返回回答 ────────│                        │
   │  ◄─── 展示回答 ───────│                        │                        │
   │  "ERC-20 是以太坊上    │                        │                        │
   │   同质化代币的标准..." │                        │                        │
```

---

## 五、三端交互时序图

```
  用户       前端       后端       Minter钱包      合约       IPFS
   │          │          │            │             │          │
   │ 打开应用  │          │            │             │          │
   │────────►│          │            │             │          │
   │          │          │            │             │          │
   │ 连接钱包  │          │            │             │          │
   │◄────────►          │            │             │          │
   │          │          │            │             │          │
   │ 选择学习  │          │            │             │          │
   │────────►│          │            │             │          │
   │          │          │            │             │          │
   │ 闯关游戏  │          │            │             │          │
   │◄────────►          │            │             │          │
   │          │          │            │             │          │
   │ 通关成功  │          │            │             │          │
   │────────►│          │            │             │          │
   │          │          │            │             │          │
   │          │ POST     │            │             │          │
   │          │ /game/   │            │             │          │
   │          │ clear    │            │             │          │
   │          │─────────►│            │             │          │
   │          │          │            │             │          │
   │          │          │ 验证+生成   │             │          │
   │          │          │ claimId     │             │          │
   │          │          │            │             │          │
   │          │          │ 签名交易   │             │          │
   │          │          │───────────►│             │          │
   │          │          │            │             │          │
   │          │          │            │ mintTo()    │          │
   │          │          │            │────────────►│          │
   │          │          │            │             │          │
   │          │          │            │             │ 校验     │
   │          │          │            │             │ 铸造     │
   │          │          │            │             │ 发事件   │
   │          │          │            │             │          │
   │          │          │            │◄────────────│          │
   │          │          │◄───────────│             │          │
   │          │          │            │             │          │
   │          │          │ 解析事件    │             │          │
   │          │          │ 存入数据库  │             │          │
   │          │          │            │             │          │
   │          │◄─────────│            │             │          │
   │          │ tokenId  │            │             │          │
   │          │ index    │            │             │          │
   │          │          │            │             │          │
   │          │ tokenURI │            │             │          │
   │          │─────────────────────────────────────►          │
   │          │◄────────────────────────────────────│          │
   │          │          │            │             │          │
   │          │ 获取元数据│            │             │          │
   │          │────────────────────────────────────────────────►
   │          │◄───────────────────────────────────────────────│
   │          │          │            │             │          │
   │◄─────────│          │            │             │          │
   │ 展示 NFT │          │            │             │          │
   │          │          │            │             │          │
```

---

## 六、API 设计

### NFT 铸造模块

#### POST /api/game/clear

用户通关后请求铸造 NFT。

请求体：

```json
{
  "userAddress": "0x...",
  "gameId": 1,
  "runId": "uuid-xxx"
}
```

成功响应：

```json
{
  "success": true,
  "tokenId": 1,
  "index": 7,
  "txHash": "0x..."
}
```

错误响应：

```json
{
  "success": false,
  "error": "ALREADY_CLAIMED | INVALID_ADDRESS | MINT_FAILED | ..."
}
```

#### GET /api/nft/list?user=0x...

查询用户拥有的 NFT 列表。

响应：

```json
{
  "nfts": [
    { "tokenId": 1, "index": 7, "gameId": 1, "mintedAt": "2025-01-29" },
    { "tokenId": 5, "index": 3, "gameId": 2, "mintedAt": "2025-01-30" }
  ]
}
```

### AI 导师模块

#### POST /api/chat

向 AI 导师提问。

请求体：

```json
{
  "message": "ERC-20 和 ERC-721 有什么区别？",
  "userId": "xxx",
  "context": "erc-721"
}
```

响应：

```json
{
  "reply": "ERC-20 是同质化代币标准，每个代币完全相同...",
  "conversationId": "xxx"
}
```

#### GET /api/chat/history?userId=xxx

获取对话历史。

响应：

```json
{
  "history": [
    { "role": "user", "content": "..." },
    { "role": "assistant", "content": "..." }
  ]
}
```

---

## 七、各端职责划分

### 前端 (apps/frontend)

**用户交互：**

- 连接钱包，获取用户地址
- 展示学习内容（漫画 + 游戏）
- 游戏/闯关逻辑
- 通关后调用后端 API

**链上读取：**

- 查询 tokenURI
- 获取用户 NFT 信息

**展示：**

- NFT 图片/信息
- AI 对话界面

**不做：**

- 不发链上交易
- 不管理私钥

### 后端 (apps/backend)

**NFT 铸造：**

- 验证通关请求
- 幂等检查（防重复发放）
- 生成 claimId
- 管理 Minter 热钱包
- 发起链上交易
- 监听事件、索引存库

**AI 导师：**

- 集成 spoon-core
- 处理对话请求
- 返回 AI 回答

**通用：**

- 数据库管理
- 日志 & 监控
- 承担 Gas 费用

### 合约 (contract)

**链上逻辑：**

- ERC-721 标准实现
- 权限控制 (`onlyMinter`)
- 防重放 (`claimUsed`)
- 随机 index 生成 (0-14)
- tokenURI 返回

**管理功能：**

- `setBaseURI()`
- `setMinter()`
- `setPaused()`

---

## 八、数据流向

```
    [用户钱包地址]              [通关数据]                [链上数据]
         │                        │                         │
         │   连接钱包获取          │   POST /game/clear      │   Minted 事件
         ▼                        ▼                         ▼
    ┌─────────┐              ┌─────────┐              ┌─────────┐
    │  前端   │─────────────►│  后端   │─────────────►│  合约   │
    └─────────┘              └─────────┘              └─────────┘
         │                        │                         │
         │                        │◄────────────────────────┤
         │                        │   解析事件、存库          │
         │                        │                         │
         │◄───────────────────────┤                         │
         │   返回 tokenId/index   │                         │
         │                        │                         │
         │   tokenURI(tokenId)    │                         │
         │──────────────────────────────────────────────────►│
         │◄──────────────────────────────────────────────────│
         │                        │                         │
         ▼                        │                         │
    ┌─────────┐                   │                         │
    │  IPFS   │                   │                         │
    │  元数据  │                   │                         │
    └─────────┘                   │                         │
         │                        │                         │
         ▼                        │                         │
    ┌─────────┐                   │                         │
    │ 展示NFT │                   │                         │
    └─────────┘                   │                         │


    [用户提问]                 [AI 处理]
         │                        │
         │   POST /api/chat       │   调用 spoon-core
         ▼                        ▼
    ┌─────────┐              ┌─────────┐              ┌─────────┐
    │  前端   │─────────────►│  后端   │─────────────►│  LLM    │
    └─────────┘              └─────────┘              └─────────┘
         │                        │                         │
         │◄───────────────────────│◄────────────────────────│
         │   展示 AI 回答          │   AI 回答               │
```

---

## 九、目录结构规划

```
web3-eip-playground/
│
├── apps/
│   ├── frontend/                    # 前端 (Next.js)
│   │   ├── app/
│   │   │   ├── page.tsx             # 首页
│   │   │   ├── eips/
│   │   │   │   ├── page.tsx         # EIP 学习列表
│   │   │   │   ├── erc-20/          # ERC-20 学习模块
│   │   │   │   ├── erc-721/         # ERC-721 学习模块
│   │   │   │   └── ...
│   │   │   ├── game/
│   │   │   │   └── [gameId]/        # 游戏页面
│   │   │   ├── nft/
│   │   │   │   └── page.tsx         # 我的 NFT
│   │   │   └── chat/
│   │   │       └── page.tsx         # AI 问答
│   │   ├── components/              # 组件
│   │   ├── hooks/                   # 自定义 hooks
│   │   │   └── useWallet.ts         # 钱包连接 hook
│   │   ├── lib/                     # 工具函数
│   │   │   └── contract.ts          # 合约交互
│   │   └── ...
│   │
│   └── backend/                     # 后端 (FastAPI) [待建]
│       ├── main.py                  # 入口
│       ├── routers/
│       │   ├── game.py              # /api/game/* 路由
│       │   ├── nft.py               # /api/nft/* 路由
│       │   └── chat.py              # /api/chat/* 路由
│       ├── services/
│       │   ├── mint_service.py      # NFT 铸造服务
│       │   ├── chat_service.py      # AI 对话服务
│       │   └── wallet_service.py    # Minter 钱包管理
│       ├── models/                  # 数据模型
│       ├── config.py                # 配置
│       ├── requirements.txt
│       └── .env.example
│
├── contract/                        # 智能合约 (Foundry) ✅ 已完成
│   ├── src/
│   │   └── GameBadgeNFT.sol
│   ├── test/
│   │   └── GameBadgeNFT.t.sol
│   ├── script/
│   │   └── Deploy.s.sol
│   └── ...
│
├── spoon-core/                      # AI Agent SDK ✅ 已引入
│   └── ...
│
├── docs/                            # 项目文档
│   └── ARCHITECTURE.md              # 本文件
│
└── README.md
```

---

## 十、安全要点

| 要点 | 说明 |
|------|------|
| **Minter 私钥** | 仅存储在后端环境变量中，不暴露给前端 |
| **Gas 费用** | 由项目方 Minter 钱包承担，用户无需付费 |
| **防重放** | 双重保障：后端幂等检查 + 合约 `claimUsed[claimId]` |
| **随机性** | 弱随机（block.prevrandao），适合展示类场景，不适用于强公平抽奖 |
| **通关验证** | 后端应验证用户确实完成了游戏，防止伪造请求 |
| **用户体验** | 用户全程无需签名或弹钱包，体验流畅 |

---

## 十一、开发现状

| 模块 | 状态 | 说明 |
|------|------|------|
| `contract/` | ✅ 完成 | GameBadgeNFT 合约、测试、部署脚本 |
| `apps/frontend/` | 🔨 框架就绪 | Next.js 初始化完成，待开发具体功能 |
| `spoon-core/` | ✅ 引入 | AI Agent SDK，待集成到后端 |
| `apps/backend/` | ❌ 未创建 | 需要新建 FastAPI 后端服务 |
| IPFS 元数据 | ❌ 未上传 | 需要准备 15 套 NFT 元数据和图片 |
| 合约部署 | ❌ 未部署 | 需要部署到测试网/主网 |
